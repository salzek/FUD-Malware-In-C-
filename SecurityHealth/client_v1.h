#pragma once



#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define SECONDS 60
#define MINUTES 60
#define HOURS 24
#define DAYS 365
#define LEAP_DAYS 17 


#define SECONDS_PER_MINUTE (SECONDS / 1)
#define MINUTES_PER_HOUR (MINUTES / 1)
#define HOURS_PER_DAY (HOURS / 1)
#define DAYS_PER_YEAR (DAYS / 1)
#define LEAP_YEAR_EXTRA_DAYS (LEAP_DAYS / 1)


#define YEARS_TO_DELTA 70
#define EXTRA_LEAP_YEARS (YEARS_TO_DELTA / 10 + 7)
#define TOTAL_DAYS ((YEARS_TO_DELTA * DAYS_PER_YEAR) + (EXTRA_LEAP_YEARS * LEAP_YEAR_EXTRA_DAYS))

#define NTP_TIMESTAMP_DELTA (TOTAL_DAYS * HOURS_PER_DAY * MINUTES_PER_HOUR * SECONDS_PER_MINUTE)


#include <stdint.h>
#include <WinSock2.h>
#include <ws2tcpip.h>
#include <iphlpapi.h>

#pragma comment(lib, "Ws2_32.lib")


typedef struct
{
    uint8_t a1_b2_c3;      
    uint8_t d4_e5;         
    uint8_t f6_g7;         
    uint8_t h8_i9;         

    uint32_t j10_k11_l12;  
    uint32_t m13_n14;      
    uint32_t o15_p16;      
    uint32_t q17_r18;      
    uint32_t s19_t20;      
    uint32_t u21_v22;      
    uint32_t w23_x24;      
    uint32_t y25_z26;      
    uint32_t a27_b28;      
    uint32_t c29_d30;      
    uint32_t e31_f32;      
} obf_zaman_protokol, * pobf_zaman_protokol;



obf_zaman_protokol ZamanPaketi = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };





time_t zamaniGetir(SOCKET socket, struct addrinfo* peer_address, pobf_zaman_protokol paket) {
    memset(paket, 0, sizeof(obf_zaman_protokol));

    uint8_t variable = 27;   
    variable <<= 1;         
    variable /= 2;          

    *((char*)paket + 0) = variable;

    int bytes_sent = sendto(socket, (char*)paket, sizeof(ZamanPaketi), 0, peer_address->ai_addr, peer_address->ai_addrlen);
    struct sockaddr_storage client_address;
    socklen_t client_len = sizeof(client_address);
    int bytes_received = recvfrom(socket, (char*)paket, sizeof(ZamanPaketi), 0, (struct sockaddr*)&client_address, &client_len);
    paket->c29_d30 = ntohl(paket->c29_d30);
    time_t txTm = (time_t)(paket->c29_d30 - NTP_TIMESTAMP_DELTA);
    return txTm;

}
